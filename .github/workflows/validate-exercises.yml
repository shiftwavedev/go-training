name: Validate Exercises

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

jobs:
  generate-matrix:
    name: Generate Exercise Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate exercise matrix
        id: set-matrix
        run: |
          # Find all exercise directories (containing go.mod)
          exercises=$(find . -type f -name "go.mod" -path "*/[0-9]*" | \
            sed 's|/go.mod||' | \
            sed 's|^\./||' | \
            jq -R -s -c 'split("\n")[:-1] | map(select(length > 0))')

          echo "matrix=$exercises" >> $GITHUB_OUTPUT
          echo "Found $(echo $exercises | jq '. | length') exercises"

  validate-starter-code:
    name: "Validate: ${{ matrix.exercise }}"
    runs-on: ubuntu-latest
    needs: generate-matrix
    strategy:
      fail-fast: false
      matrix:
        exercise: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: ${{ matrix.exercise }}/go.mod

      - name: Get exercise info
        id: info
        run: |
          exercise_name=$(basename "${{ matrix.exercise }}")
          category=$(dirname "${{ matrix.exercise }}")
          echo "name=$exercise_name" >> $GITHUB_OUTPUT
          echo "category=$category" >> $GITHUB_OUTPUT

      - name: Verify go.mod exists
        working-directory: ${{ matrix.exercise }}
        run: |
          if [ ! -f "go.mod" ]; then
            echo "âŒ Missing go.mod"
            exit 1
          fi
          echo "âœ… go.mod found"

      - name: Download dependencies
        working-directory: ${{ matrix.exercise }}
        run: |
          go mod download
          go mod verify

      - name: Compile starter code
        working-directory: ${{ matrix.exercise }}
        run: |
          echo "ðŸ”¨ Compiling starter code..."
          if ! go build -v ./...; then
            echo "âŒ Starter code compilation failed"
            exit 1
          fi
          echo "âœ… Starter code compiles"

      - name: Run tests on starter code (expected to fail)
        working-directory: ${{ matrix.exercise }}
        run: |
          echo "ðŸ§ª Running tests on starter code (failures expected)..."
          if go test -v ./... 2>&1 | tee test_output.txt; then
            echo "âš ï¸  Warning: Starter code tests passed (should have TODOs)"
          else
            echo "âœ… Tests failed as expected (TODOs present)"
          fi
        continue-on-error: true

  validate-solutions:
    name: "Solution: ${{ matrix.exercise }}"
    runs-on: ubuntu-latest
    needs: generate-matrix
    strategy:
      fail-fast: false
      matrix:
        exercise: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: ${{ matrix.exercise }}/go.mod

      - name: Check if solution exists
        id: check-solution
        run: |
          if [ -f "${{ matrix.exercise }}/solution/main.go" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Solution found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No solution found"
          fi

      - name: Test solution
        if: steps.check-solution.outputs.exists == 'true'
        working-directory: ${{ matrix.exercise }}
        run: |
          echo "ðŸ§ª Testing solution implementation..."

          # Backup starter code
          cp main.go main.go.backup

          # Copy solution
          cp solution/main.go main.go

          # Run tests
          if go test -v -cover ./...; then
            echo "âœ… Solution tests passed"
          else
            echo "âŒ Solution tests failed"
            exit 1
          fi

          # Restore starter code
          mv main.go.backup main.go

      - name: Run race detector (concurrency exercises)
        if: steps.check-solution.outputs.exists == 'true' && contains(matrix.exercise, 'concurrency')
        working-directory: ${{ matrix.exercise }}
        run: |
          echo "ðŸ Running race detector..."

          # Copy solution
          cp main.go main.go.backup
          cp solution/main.go main.go

          # Run with race detector and -short flag to skip intentionally buggy code
          if go test -race -short -v ./...; then
            echo "âœ… No race conditions detected"
          else
            echo "âŒ Race conditions found"
            exit 1
          fi

          # Restore
          mv main.go.backup main.go

      - name: Check solution documentation
        if: steps.check-solution.outputs.exists == 'true'
        run: |
          if [ -f "${{ matrix.exercise }}/solution/EXPLANATION.md" ]; then
            echo "âœ… Solution documentation found"
          else
            echo "âš ï¸  Missing EXPLANATION.md"
          fi

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-starter-code, validate-solutions]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Exercise Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All exercises validated!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Starter code compilation: Verified" >> $GITHUB_STEP_SUMMARY
          echo "- Solution tests: Verified" >> $GITHUB_STEP_SUMMARY
          echo "- Race detection: Verified (concurrency exercises)" >> $GITHUB_STEP_SUMMARY
